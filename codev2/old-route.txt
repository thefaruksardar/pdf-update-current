// app/api/html-to-pdf/route.ts (COMPLETE - FIXED: file.pdfMeta everywhere)
import { NextRequest } from "next/server";
import { chromium } from "playwright";
import JSZip from "jszip";
import { PDFDocument } from "pdf-lib"; // npm i pdf-lib

export const runtime = "nodejs";

type PdfMeta = {
  author: string;
  subject: string;
  keywords: string;
  created: string;
  modified: string;
};

type IncomingFile = {
  name: string;
  html: string;
  pdfMeta?: PdfMeta; // ✅ Matches frontend UploadFile
};

type PdfItem = {
  name: string;
  buffer: Buffer;
};

export async function POST(req: NextRequest) {
  const { files } = (await req.json()) as { files: IncomingFile[] };

  if (!Array.isArray(files) || files.length === 0) {
    return new Response(JSON.stringify({ error: "No files provided" }), {
      status: 400,
      headers: { "Content-Type": "application/json" },
    });
  }

  const browser = await chromium.launch();
  try {
    const pdfBuffers: PdfItem[] = [];

    for (const file of files) {
      const page = await browser.newPage();

      // Extract title FIRST
      await page.setContent(file.html, { waitUntil: "networkidle" });

      const titleText =
        (await page.locator("h1").first().textContent())?.trim() ||
        "Untitled Document";

      // Inject <title> WITHOUT reloading
      await page.evaluate((title) => {
        const titleEl = document.querySelector("title");
        if (!titleEl) {
          const newTitle = document.createElement("title");
          newTitle.textContent = title;
          document.head.appendChild(newTitle);
        }
      }, titleText);

      // Generate PDF immediately
      let pdfBuffer = (await page.pdf({
        format: "A4",
        printBackground: true,
        scale: 0.8,
        margin: {
          // ← Reduce margins
          top: "0.5in",
          bottom: "0.5in",
          left: "0.5in",
          right: "0.5in",
        },
      })) as Buffer;

      await page.close();

      // ✅ FIXED: Use file.pdfMeta (matches frontend)
      if (file.pdfMeta) {
        console.log("Applying metadata:", file.pdfMeta);
        const pdfDoc = await PDFDocument.load(pdfBuffer);

        if (file.pdfMeta.author) pdfDoc.setAuthor(file.pdfMeta.author);
        if (file.pdfMeta.subject) pdfDoc.setSubject(file.pdfMeta.subject);
        if (file.pdfMeta.keywords) {
          const keywordsArray = file.pdfMeta.keywords
            .split(",")
            .map((k) => k.trim())
            .filter(Boolean);
          pdfDoc.setKeywords(keywordsArray);
        }

        if (file.pdfMeta.created) {
          try {
            pdfDoc.setCreationDate(new Date(file.pdfMeta.created));
          } catch (e) {
            console.warn("Invalid created date:", file.pdfMeta.created);
          }
        }
        if (file.pdfMeta.modified) {
          try {
            pdfDoc.setModificationDate(new Date(file.pdfMeta.modified));
          } catch (e) {
            console.warn("Invalid modified date:", file.pdfMeta.modified);
          }
        }

        pdfDoc.setProducer("Faruk Sardar");

        const pdfBytes = await pdfDoc.save();
        pdfBuffer = Buffer.from(pdfBytes);
      }

      const name = file.name.endsWith(".pdf") ? file.name : `${file.name}.pdf`;
      pdfBuffers.push({ name, buffer: pdfBuffer });
    }

    // Single PDF response
    if (pdfBuffers.length === 1) {
      const pdf = pdfBuffers[0];
      const uint8 = new Uint8Array(
        pdf.buffer.buffer,
        pdf.buffer.byteOffset,
        pdf.buffer.byteLength
      );
      return new Response(uint8 as BodyInit, {
        headers: {
          "Content-Type": "application/pdf",
          "Content-Disposition": `attachment; filename="${pdf.name}"`,
        },
      });
    }

    // ZIP multiple PDFs
    const zip = new JSZip();
    for (const pdf of pdfBuffers) {
      zip.file(pdf.name, pdf.buffer);
    }
    const zipArrayBuffer = await zip.generateAsync({
      type: "arraybuffer",
      compression: "DEFLATE",
    });
    const zipUint8 = new Uint8Array(zipArrayBuffer);
    return new Response(zipUint8, {
      headers: {
        "Content-Type": "application/zip",
        "Content-Disposition": 'attachment; filename="updated-pdfs.zip"',
      },
    });
  } finally {
    await browser.close();
  }
}
